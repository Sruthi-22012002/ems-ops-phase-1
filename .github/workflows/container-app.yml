name: Deploy to Azure React  Container Apps

on:
  push:
    branches:
      - main 

env:
  AZURE_CONTAINER_REGISTRY: youracrname.azurecr.io
  BACKEND_IMAGE_NAME: backend-app
  FRONTEND_IMAGE_NAME: frontend-app
  RESOURCE_GROUP: your-resource-group
  CONTAINER_APP_BACKEND: backend-container-app
  CONTAINER_APP_FRONTEND: frontend-container-app

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry (ACR)
        run: az acr login --name youracrname

      - name: Build and push backend image
        run: |
          docker build -t $AZURE_CONTAINER_REGISTRY/$BACKEND_IMAGE_NAME:latest ./backend
          docker push $AZURE_CONTAINER_REGISTRY/$BACKEND_IMAGE_NAME:latest

      - name: Build and push frontend image
        run: |
          docker build -t $AZURE_CONTAINER_REGISTRY/$FRONTEND_IMAGE_NAME:latest ./frontend
          docker push $AZURE_CONTAINER_REGISTRY/$FRONTEND_IMAGE_NAME:latest

      - name: Deploy Backend to Azure Container Apps
        run: |
          az containerapp update \
            --name $CONTAINER_APP_BACKEND \
            --resource-group $RESOURCE_GROUP \
            --image $AZURE_CONTAINER_REGISTRY/$BACKEND_IMAGE_NAME:latest \
            --set-env-vars "ENV=production"

      - name: Deploy Frontend to Azure Container Apps
        run: |
          az containerapp update \
            --name $CONTAINER_APP_FRONTEND \
            --resource-group $RESOURCE_GROUP \
            --image $AZURE_CONTAINER_REGISTRY/$FRONTEND_IMAGE_NAME:latest \
            --set-env-vars "ENV=production"

